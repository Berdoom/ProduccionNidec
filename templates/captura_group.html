{% extends "layout.html" %}

{% block title %}Captura de Producción - {{ group_name }}{% endblock %}
{% block page_header %}Captura de Producción {{ group_name }}{% endblock %}

{% block content %}
<div class="content-section">
    <form id="productionForm" action="{{ url_for('captura', group=group_name.lower()) }}" method="POST" 
          data-group="{{ group_name.lower() }}" 
          data-submit-reason-url="{{ url_for('submit_reason') }}">
        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        
        <!-- Selector de Fecha -->
        <div class="form-row align-items-center mb-4">
            <div class="col-auto"><label for="fecha" class="col-form-label font-weight-bold">Fecha:</label></div>
            <div class="col-sm-4"><input type="date" class="form-control" id="fecha" name="fecha" value="{{ selected_date | e }}" onchange="handleDateChange()"></div>
            <div class="col-auto"><a href="{{ url_for('captura', group=group_name.lower()) }}" class="btn btn-secondary"><i class="fas fa-calendar-day"></i> Hoy</a></div>
        </div>

        <h4 class="mt-5">Producción por Área</h4>

        <!-- =================================== -->
        <!--        VISTA PARA ESCRITORIO        -->
        <!-- =================================== -->
        <div class="table-responsive desktop-only">
            <table class="table table-bordered" style="min-width: 1600px;">
                <thead class="thead-light">
                    <tr class="text-center">
                        <th rowspan="2" class="align-middle" style="width: 12%;">Área</th>
                        <th rowspan="2" class="align-middle">Pronóstico<br>Total</th>
                        <!-- Cabeceras para cada turno -->
                        {% for turno_name in nombres_turnos %}
                        <th colspan="{{ horas_turno[turno_name]|length + 2 }}">Turno {{ loop.index }} ({{ turno_name }})</th>
                        {% endfor %}
                        <th rowspan="2" class="align-middle">Total<br>Producido</th>
                    </tr>
                    <tr class="text-center">
                        {% for turno_name in nombres_turnos %}
                        <th>Prono.</th>
                        {% for hora in horas_turno[turno_name] %}<th>{{ hora }}</th>{% endfor %}
                        <th>Total Turno</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for area in areas if area != 'Output' %}
                    {% set area_slug = area | slug %}
                    <tr data-area-slug="{{ area_slug }}">
                        <td class="font-weight-bold">{{ area }}</td>
                        <td class="text-center align-middle font-weight-bold total-column" id="total_pronostico_area_{{ area_slug }}">0</td>
                        
                        <!-- Celdas para cada turno -->
                        {% for turno_name in nombres_turnos %}
                            {% set turno_slug = turno_name | slug %}
                            {% set turno_data = data.get(area, {}).get(turno_name, {}) %}
                            <td>
                                <input type="number" name="pronostico_{{ area_slug }}_{{ turno_slug }}"
                                       value="{{ turno_data.get('pronostico', '') | e }}"
                                       min="0" class="form-control text-center pronostico-turno-input"
                                       oninput="calculateAllTotals('{{ area_slug }}')">
                            </td>
                            {% for hora in horas_turno[turno_name] %}
                            <td>
                                <input type="number" name="produccion_{{ area_slug }}_{{ hora }}"
                                       value="{{ turno_data.get(hora, '') | e }}"
                                       min="0" class="form-control text-center"
                                       oninput="calculateAllTotals('{{ area_slug }}')">
                            </td>
                            {% endfor %}
                            <td class="text-center align-middle font-weight-bold turno-total-cell">
                                <span id="total_produccion_turno_{{ area_slug }}_{{ turno_slug }}">0</span>
                                <!-- Contenedor para el ícono de razón -->
                                <span class="reason-icon-container" 
                                      id="reason_icon_container_{{ area_slug }}_{{ turno_slug }}"
                                      data-toggle="modal" 
                                      data-target="#reasonModal"
                                      data-area-name="{{ area }}"
                                      data-turno-name="{{ turno_name }}"
                                      data-date="{{ selected_date }}"
                                      onclick="setReasonModalData(this)">
                                </span>
                            </td>
                        {% endfor %}
                        
                        <td class="text-center align-middle font-weight-bold total-column" id="total_produccion_area_{{ area_slug }}">0</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- =================================== -->
        <!--          VISTA PARA MÓVIL           -->
        <!-- =================================== -->
        <div id="accordionCaptura" class="accordion-responsive">
        {% for area in areas if area != 'Output' %}
            {% set area_slug = area | slug %}
            <div class="card">
                <div class="card-header" id="heading{{ area_slug }}">
                    <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapse{{ area_slug }}" aria-expanded="false" aria-controls="collapse{{ area_slug }}">
                        {{ area }}
                    </button>
                </div>
                <div id="collapse{{ area_slug }}" class="collapse" aria-labelledby="heading{{ area_slug }}" data-parent="#accordionCaptura">
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for turno_name in nombres_turnos %}
                                {% set turno_slug = turno_name | slug %}
                                {% set turno_data = data.get(area, {}).get(turno_name, {}) %}
                                <li class="list-group-item turno-header">{{ turno_name }}</li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <strong>Pronóstico:</strong>
                                    <input type="number" name="mobile_pronostico_{{ area_slug }}_{{ turno_slug }}" value="{{ turno_data.get('pronostico', '') | e }}" class="form-control-sm" style="width: 100px;" oninput="syncAndCalc('pronostico', '{{ area_slug }}', '{{ turno_slug }}', this.value)">
                                </li>
                                {% for hora in horas_turno[turno_name] %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <strong>{{ hora }}:</strong>
                                    <input type="number" name="mobile_produccion_{{ area_slug }}_{{ hora }}" value="{{ turno_data.get(hora, '') | e }}" class="form-control-sm" style="width: 100px;" oninput="syncAndCalc('produccion', '{{ area_slug }}', '{{ hora }}', this.value)">
                                </li>
                                {% endfor %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <strong>Total Turno:</strong>
                                    <div>
                                        <strong id="mobile_total_produccion_turno_{{ area_slug }}_{{ turno_slug }}">0</strong>
                                        <span class="reason-icon-container" 
                                              id="mobile_reason_icon_container_{{ area_slug }}_{{ turno_slug }}"
                                              data-toggle="modal" 
                                              data-target="#reasonModal"
                                              data-area-name="{{ area }}"
                                              data-turno-name="{{ turno_name }}"
                                              data-date="{{ selected_date }}"
                                              onclick="setReasonModalData(this)">
                                        </span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>

        <!-- Sección de Output -->
        <h4 class="mt-5">Producción Final (Output)</h4>
        <div class="table-responsive">
             <table class="table table-bordered">
                <thead><tr><th>Área</th><th>Pronóstico</th><th>Output</th></tr></thead>
                <tbody>
                    <tr>
                        <td style="font-weight: 600;">Output</td>
                        <td><input type="number" name="pronostico_output" class="form-control" value="{{ output_data.pronostico | e }}" min="0"></td>
                        <td><input type="number" name="produccion_output" class="form-control" value="{{ output_data.output | e }}" min="0"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="text-center mt-4">
             <button type="submit" class="btn btn-lg btn-nidec-style"><i class="fas fa-save"></i> Guardar Todos los Cambios</button>
        </div>
    </form>
</div>

{% include 'modals/reason_modal.html' %}
{% include 'modals/feedback_modal.html' %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/captura.js') }}"></script>
<script>
    // Estas variables globales son necesarias para el archivo captura.js
    const HORAS_TURNO_JS = {{ horas_turno | tojson }};
    const NOMBRES_TURNOS_JS = {{ nombres_turnos | tojson }};
    const PRONOSTICOS_DATA_JS = {{ data | tojson }}; // Contiene pronósticos y razones existentes
</script>
{% endblock %}
