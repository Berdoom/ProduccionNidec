{% extends "layout.html" %}

{% block title %}Dashboard Admin{% endblock %}
{% block page_header %}Dashboard Admin{% endblock %}

{% block content %}
<!-- Encabezado con Selector de Fecha -->
<div class="content-section d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Análisis para: <strong>{{ period_label }}</strong></h4>
    <form method="GET" action="{{ url_for('dashboard_admin') }}" class="form-inline">
        <div class="form-group mb-0">
            <label for="fecha" class="mr-2 font-weight-bold">Seleccionar Fecha:</label>
            <input type="date" class="form-control" id="fecha" name="fecha" value="{{ selected_date }}">
        </div>
        <button type="submit" class="btn btn-nidec-style ml-2"><i class="fas fa-search"></i> Consultar</button>
        <a href="{{ url_for('dashboard_admin') }}" class="btn btn-secondary ml-2"><i class="fas fa-calendar-day"></i> Hoy</a>
    </form>
</div>


<!-- KPIs CON RUEDAS DE PROGRESO (SE OCULTAN EN MÓVIL) -->
<div class="row text-center mb-4 d-none d-lg-flex">
    <!-- Rueda Nidec General -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="kpi-wheel-card">
            <div class="circular-progress-kpi {{ global_kpis.eficiencia|heatmap_color }}" style="--value: {{ global_kpis.eficiencia }}">
                <span class="progress-value">{{ "%.1f"|format(global_kpis.eficiencia) }}%</span>
            </div>
            <h5 class="mt-3 font-weight-bold">Nidec General</h5>
            <p class="text-muted h4">{{ global_kpis.producido }} / {{ global_kpis.pronostico }}</p>
        </div>
    </div>
    <!-- Rueda IHP -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="kpi-wheel-card">
            <div class="circular-progress-kpi {{ ihp_data.eficiencia|heatmap_color }}" style="--value: {{ ihp_data.eficiencia }}">
                <span class="progress-value">{{ "%.1f"|format(ihp_data.eficiencia) }}%</span>
            </div>
            <h5 class="mt-3 font-weight-bold">Resumen IHP</h5>
            <p class="text-muted h4">{{ ihp_data.producido }} / {{ ihp_data.pronostico }}</p>
        </div>
    </div>
    <!-- Rueda FHP -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="kpi-wheel-card">
            <div class="circular-progress-kpi {{ fhp_data.eficiencia|heatmap_color }}" style="--value: {{ fhp_data.eficiencia }}">
                <span class="progress-value">{{ "%.1f"|format(fhp_data.eficiencia) }}%</span>
            </div>
            <h5 class="mt-3 font-weight-bold">Resumen FHP</h5>
            <p class="text-muted h4">{{ fhp_data.producido }} / {{ fhp_data.pronostico }}</p>
        </div>
    </div>
</div>


<!-- TABLAS CONSOLIDADAS POR GRUPO -->
{% for group, areas_data in performance_data.items() %}
<div class="content-section">
    <h3 class="mb-4 font-weight-bold" style="color: var(--nidec-green-dark);">Desempeño Detallado - {{ group }}</h3>
    
    <!-- VISTA DE ESCRITORIO -->
    <div class="table-responsive desktop-only-table">
        <table class="table group-performance-table table-bordered table-hover">
            <thead class="text-center thead-light">
                <tr>
                    <th rowspan="2" class="align-middle">Área</th>
                    {% for turno_name in nombres_turnos %}<th colspan="{{ horas_turno[turno_name]|length + 3 }}">{{ turno_name }}</th>{% endfor %}
                </tr>
                <tr>
                    {% for turno_name in nombres_turnos %}
                    <th>Pron.</th>
                    {% for hora in horas_turno[turno_name] %}<th>{{ hora }}</th>{% endfor %}
                    <th>Total Prod.</th>
                    <th>Eficiencia</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for area, turnos in areas_data.items() %}
                <tr>
                    <td class="area-name-cell">{{ area }}</td>
                    {% for turno_name in nombres_turnos %}
                        {% set turno_data = turnos[turno_name] %}
                        {% set eficiencia = turno_data.eficiencia %}
                        <td class="text-center font-weight-bold">{{ turno_data.pronostico }}</td>
                        {% for hora in horas_turno[turno_name] %}<td class="text-center hourly-data-cell">{{ turno_data.horas.get(hora, '-') }}</td>{% endfor %}
                        <td class="text-center font-weight-bold">{{ turno_data.producido }}</td>
                        <td class="text-center efficiency-cell">
                            <div class="progress" style="height: 22px; font-size: 0.9rem;">
                                <div class="progress-bar font-weight-bold {{ eficiencia|heatmap_color }}" role="progressbar" style="width: {{ eficiencia }}%;" aria-valuenow="{{ eficiencia }}" aria-valuemin="0" aria-valuemax="100">{{ "%.1f"|format(eficiencia) }}%</div>
                            </div>
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- VISTA MÓVIL -->
    <div class="mobile-only-view">
        <!-- NUEVO: Mensaje para girar el dispositivo -->
        <div class="rotate-device-prompt">
            <i class="fas fa-sync-alt"></i>
            <span>Gira tu dispositivo para ver la tabla completa</span>
        </div>
        
        <div class="accordion mobile-accordion" id="accordion-{{ group }}">
            {% for area, turnos in areas_data.items() %}
            <div class="card">
                <div class="card-header" id="heading-{{ group }}-{{ area|slug }}">
                    <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse-{{ group }}-{{ area|slug }}">
                        {{ area }}
                    </button>
                </div>
                <div id="collapse-{{ group }}-{{ area|slug }}" class="collapse" data-parent="#accordion-{{ group }}">
                    <div class="card-body">
                        <div class="accordion" id="accordion-shifts-{{ group }}-{{ area|slug }}">
                            {% for turno_name in nombres_turnos %}
                            {% set turno_data = turnos[turno_name] %}
                            {% set eficiencia = turno_data.eficiencia %}
                            <div class="card shift-card">
                                <div class="card-header shift-header" id="heading-shift-{{ group }}-{{ area|slug }}-{{ turno_name|slug }}">
                                    <button class="btn btn-link btn-block text-left" data-toggle="collapse" data-target="#collapse-shift-{{ group }}-{{ area|slug }}-{{ turno_name|slug }}">
                                        {{ turno_name }}
                                        <span class="badge badge-pill float-right {{ eficiencia|heatmap_color_badge }}">{{ "%.0f"|format(eficiencia) }}%</span>
                                    </button>
                                </div>
                                <div id="collapse-shift-{{ group }}-{{ area|slug }}-{{ turno_name|slug }}" class="collapse" data-parent="#accordion-shifts-{{ group }}-{{ area|slug }}">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between"><span>Pronóstico:</span> <strong>{{ turno_data.pronostico }}</strong></li>
                                        {% for hora in horas_turno[turno_name] %}
                                        <li class="list-group-item d-flex justify-content-between text-muted"><span><i class="far fa-clock mr-2"></i>{{ hora }}:</span> <span>{{ turno_data.horas.get(hora, '-') }}</span></li>
                                        {% endfor %}
                                        <li class="list-group-item d-flex justify-content-between"><span>Total Producido:</span> <strong>{{ turno_data.producido }}</strong></li>
                                    </ul>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}